<template>
  <Wrapper>
    <Header v-if="!fullscreen">
      <span class="title">BrainBox</span>
    </Header>
    <main>
      <div
        class="left"
        v-if="!fullscreen"
      >
        <div
          class="privilegedAccessInfo"
          v-if="displayPrivilegedAccessWarning"
        >
          You are seeing this private MRI because you were added as a
          collaborator with access to files. Share with caution.
        </div>
        <div class="annotationsPane">
          <table class="info">
            <tbody>
              <tr>
                <th>Name</th>
                <td>
                  <span class="noEmpty">{{ name }}</span>
                </td>
              </tr>

              <tr>
                <th>Data&nbsp;source</th>
                <td>
                  <span style="word-break: break-all">{{ source }}</span>
                </td>
              </tr>

              <tr>
                <th>Inclusion&nbsp;date</th>
                <td>
                  <span>{{ date }}</span>
                </td>
              </tr>
            </tbody>
          </table>
          <h2>Volume annotations</h2>
          <Table id="annotations">
            <thead>
              <tr>
                <th>Name</th>
                <th>Value</th>
                <th>Project</th>
                <th>Modified</th>
                <th>Access</th>
              </tr>
            </thead>
            <tbody>
              <tr
                v-for="(atlas, index) in atlases"
                :class="{ selected: selectedIndex === index }"
                :key="atlas.filename"
                @click="selectVolumeAnnotation(index)"
              >
                <td>{{ atlas.name }}</td>
                <td class="annotation-label">
                  {{ labelsName[atlas.labels] }}
                </td>
                <td>
                  <a :href="`/project/${atlas.project}`">{{ atlas.project }}</a>
                </td>
                <td>{{ new Date(atlas.modified).toLocaleDateString() }}</td>
                <td>
                  <Access
                    :collaborator="collaboratorAccess[atlas.filename]"
                    type="files"
                    readonly
                  />
                </td>
              </tr>
            </tbody>
          </Table>
          <h2>Text annotations</h2>
          <Table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Value</th>
                <th>Project</th>
                <th>Modified</th>
              </tr>
            </thead>
            <tbody>
              <tr
                v-for="annotation in formattedTextAnnotations"
                :key="annotation.name"
              >
                <td class="noEmpty">
                  {{ annotation.name }}
                </td>
                <td class="noEmpty">
                  {{ annotation.data }}
                </td>
                <td>
                  <a
                    class="noEmpty"
                    :href="`/project/${annotation.project}`"
                  >{{
                    annotation.project
                  }}</a>
                </td>
                <td class="noEmpty">
                  {{ new Date(annotation.modified).toLocaleDateString() }}
                </td>
              </tr>
            </tbody>
          </Table>
        </div>
      </div>
      <div class="right">
        <Editor
          :title="title"
          :class="{fullscreen, reduced}"
        >
          <template #tools>
            <Tools />
          </template>
          <template #content>
            <div
              id="stereotaxic"
            />
            <OntologySelector
              :ontology="ontology"
              :open="displayOntology"
              @on-close="displayOntology = false"
              @label-click="handleOntologyLabelClick"
            />
            <AdjustSettings
              v-if="displayAdjustSettings"
              v-model:alpha="alpha"
              @update:alpha="changeAlpha"
              v-model:brightness="brightness"
              @update:brightness="changeBrightness"
              v-model:contrast="contrast"
              @update:contrast="changeContrast"
            />
          </template>
        </Editor>
      </div>
    </main>
  </Wrapper>
</template>
<script setup>
/* global AtlasMakerWidget BrainBox params mriInfo hasPrivilegedAccess */
import { keyBy, mapValues, flatten, map } from 'lodash';
import get from 'lodash/get';
import {
  Wrapper,
  Header,
  Editor,
  Table,
  Access,
  OntologySelector,
  AdjustSettings
} from 'nwl-components';
import { ref, onMounted, watch, computed } from 'vue';

import useVisualization from '../store/visualization';

import Tools from './Tools.vue';

const {
  displayAdjustSettings,
  displayOntology,
  alpha,
  brightness,
  contrast,
  ontology,
  currentLabel,
  changeAlpha,
  changeBrightness,
  changeContrast,
  fullscreen,
  displayChat,
  displayScript,
  title,
  init: initVisualization
} = useVisualization();

displayChat.value = false;

const selectedIndex = ref(0);
const reduced = computed(() => !displayChat.value && !displayScript.value);

watch(fullscreen, () => {
  if (fullscreen.value && !displayScript.value) {
    displayChat.value = true;
  }

  // setTimeout(() => {
  //   // document.querySelector('#resizable').style = '';
  //   AtlasMakerWidget.resizeWindow();
  // }, 100);
});

const selectVolumeAnnotation = async (index) => {
  selectedIndex.value = index;
  await AtlasMakerWidget.configureAtlasMaker(BrainBox.info, index);
  ontology.value = AtlasMakerWidget.ontology;
  currentLabel.value = 0;
};

const annotations = get(mriInfo, 'mri.annotations', {});
const formattedTextAnnotations = flatten(
  map(annotations, (nestedAnnotations, project) =>
    map(nestedAnnotations, (annotation, name) => ({
      ...annotation,
      project,
      name
    }))
  )
);

const atlases = get(mriInfo, 'mri.atlas', {});
const labelsName = ref({});
const { name, source } = mriInfo;
const date = new Date(mriInfo.included).toLocaleDateString();
const collaboratorAccess = mapValues(keyBy(atlases, 'filename'), (atlas) => ({ access: { files: atlas.access }}));
const displayPrivilegedAccessWarning = hasPrivilegedAccess;

const handleOntologyLabelClick = (index) => {
  displayOntology.value = false;
  currentLabel.value = index;
  AtlasMakerWidget.changePenColor(index);
};

onMounted(async () => {
  await initVisualization();
  const labels = await (await fetch('/api/getLabelsets')).json();
  labelsName.value = mapValues(keyBy(labels, 'source'), 'name');
  params.info = mriInfo;
  try {
    await BrainBox.configureBrainBox(params);
    ontology.value = AtlasMakerWidget.ontology;
  } catch (e) {
    console.error('Error configuring BrainBox:', e);
    title.value = 'Error';
  }
  currentLabel.value = 0;
});
</script>
<style scoped>
main {
  display: flex;
  padding: 0;
  justify-content: center;
  margin: 0 auto;
}

.container {
  position: relative;
}

:deep(.area.fullscreen) {
  position: absolute;
  width: 100%;
  height: 100%;
  left: 0;
}

.left {
  flex-grow: 1;
  max-width: 900px;
}

.privilegedAccessInfo {
  background-color: #3B3B3B;
  padding: 10px 20px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
}

.privilegedAccessInfo:before {
    content: '\1F512';
    font-size: 25px;
    margin-right: 15px;
    background: #2B2B2B;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.info {
  margin-bottom: 20px;
}

.info th {
  font-weight: bold;
}

.annotationsPane {
  background-color: #333;
  padding: 20px;
  margin-bottom: 20px;
}

.noEmpty:empty:before {
  content: "Empty";
  color: rgba(255, 255, 255, 0.4);
}

.tools {
  width: 100%;
}

:deep(button), :deep(.group) {
    height: 24px;
    margin: 1px;
}

#stereotaxic {
  width: 600px;
}

.fullscreen #stereotaxic {
  width: 100%;
  height: 100%;
}

/******************************** resizable layout ******************************/

/* for smaller screen (mobile, small iPad) */
@media(max-width: 1300px) {
  main {
    flex-direction: column;
    max-width: 700px;
  }
  #stereotaxic {
    min-width: 100%;
  }
}

/* for larger screen (computer, big iPad, small iPad landscape) */
@media(min-width: 1300px) {
  main {
    flex-direction: row;
  }
  .left {
    margin-right: 20px;
  }
}

</style>
